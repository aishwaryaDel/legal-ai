import { useState, useEffect } from 'react';
import { Building2, MapPin, Calendar, DollarSign, AlertTriangle, Search, Users, AlertCircle } from 'lucide-react';
import { supabase } from '../../lib/supabase';
import { shouldShowPaymentTerms, shouldShowLiabilityTerms, getContextualWarnings } from '../../lib/builderRules';

interface Partner {
  id: string;
  name: string;
  legal_name: string | null;
  country: string | null;
  jurisdiction: string | null;
  risk_rating: string | null;
}

interface Step2Props {
  state: {
    party_our_entity_name?: string;
    counterparty_name?: string;
    counterparty_country?: string;
    counterparty_registration?: string;
    effective_date?: string;
    payment_terms?: string;
    termination_notice?: string;
    liability_cap_model?: string;
  };
  contextState: {
    jurisdiction?: string;
    document_type?: string;
    purpose_tags?: string[];
    sensitivity_level?: string;
    criticality_level?: string;
  };
  onChange: (updates: Partial<Step2Props['state']>) => void;
  isDark: boolean;
}

const PAYMENT_TERMS = [
  { id: 'net_30', name: 'Net 30 days', description: 'Payment due 30 days after invoice' },
  { id: 'net_60', name: 'Net 60 days', description: 'Payment due 60 days after invoice' },
  { id: 'advance', name: 'Advance payment', description: 'Payment before service delivery' },
  { id: 'custom', name: 'Custom', description: 'Define specific terms' },
];

const TERMINATION_NOTICE = [
  { id: '30_days', name: '30 days notice', description: 'Standard for short-term agreements' },
  { id: '60_days', name: '60 days notice', description: 'Balanced approach' },
  { id: '90_days', name: '90 days notice', description: 'For strategic partnerships' },
];

const LIABILITY_CAP_MODELS = [
  { id: 'fees_12m', name: 'Limited to fees paid (12 months)', description: 'Standard limitation, caps liability at fees paid in last 12 months', risk: 'Low' },
  { id: 'absolute_cap', name: 'Absolute cap (fixed amount)', description: 'Fixed maximum liability amount regardless of fees', risk: 'Medium' },
  { id: 'unlimited', name: 'Unlimited liability', description: 'No cap on liability - requires legal approval', risk: 'High' },
];

export function Step2PartiesTerms({ state, contextState, onChange, isDark }: Step2Props) {
  const [formData, setFormData] = useState({
    party_our_entity_name: state.party_our_entity_name || 'TESA GmbH',
    counterparty_name: state.counterparty_name || '',
    counterparty_country: state.counterparty_country || '',
    counterparty_registration: state.counterparty_registration || '',
    effective_date: state.effective_date || new Date().toISOString().split('T')[0],
    payment_terms: state.payment_terms || 'net_30',
    termination_notice: state.termination_notice || '30_days',
    liability_cap_model: state.liability_cap_model || 'fees_12m',
  });

  const [showJurisdictionWarning, setShowJurisdictionWarning] = useState(false);
  const [useExistingPartner, setUseExistingPartner] = useState(true);
  const [partnerSearchQuery, setPartnerSearchQuery] = useState('');
  const [partnerSuggestions, setPartnerSuggestions] = useState<Partner[]>([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [selectedPartnerId, setSelectedPartnerId] = useState<string | null>(null);

  useEffect(() => {
    onChange(formData);
  }, [formData]);

  useEffect(() => {
    if (partnerSearchQuery.length >= 2) {
      searchPartners(partnerSearchQuery);
    } else {
      setPartnerSuggestions([]);
    }
  }, [partnerSearchQuery]);

  const searchPartners = async (query: string) => {
    try {
      const { data, error } = await supabase
        .from('partners')
        .select('id, name, legal_name, country, jurisdiction, risk_rating')
        .or(`name.ilike.%${query}%,legal_name.ilike.%${query}%`)
        .limit(5);

      if (error) throw error;
      setPartnerSuggestions(data || []);
      setShowSuggestions(true);
    } catch (err) {
      console.error('Failed to search partners:', err);
    }
  };

  const selectPartner = (partner: Partner) => {
    setSelectedPartnerId(partner.id);
    setPartnerSearchQuery(partner.name);
    setShowSuggestions(false);

    setFormData(prev => ({
      ...prev,
      counterparty_name: partner.legal_name || partner.name,
      counterparty_country: partner.country || '',
      counterparty_registration: '',
    }));
  };

  useEffect(() => {
    if (contextState.jurisdiction && formData.counterparty_country) {
      const cpCountryCode = formData.counterparty_country.split('-')[0];
      const jurisdictionCode = contextState.jurisdiction.split('-')[0];

      setShowJurisdictionWarning(cpCountryCode !== jurisdictionCode);
    }
  }, [formData.counterparty_country, contextState.jurisdiction]);

  const handleChange = (field: string, value: string) => {
    setFormData(prev => ({ ...prev, [field]: value }));
  };

  const showPaymentFields = shouldShowPaymentTerms(
    contextState.document_type,
    contextState.purpose_tags
  );

  const showLiabilityFields = shouldShowLiabilityTerms(
    contextState.document_type,
    contextState.purpose_tags
  );

  const warnings = getContextualWarnings(
    contextState.document_type,
    contextState.purpose_tags,
    contextState.sensitivity_level,
    contextState.criticality_level,
    formData.liability_cap_model
  );

  return (
    <div className="space-y-8">
      <div>
        <h2 className={`text-2xl font-bold mb-2 ${isDark ? 'text-white' : 'text-slate-900'}`}>
          Who's involved and what are the terms?
        </h2>
        <p className={`${isDark ? 'text-slate-400' : 'text-slate-600'}`}>
          Enter the party details and key commercial terms for this agreement
        </p>
      </div>

      <div className={`p-6 rounded-xl border ${isDark ? 'bg-slate-800/50 border-slate-700' : 'bg-white border-slate-200'}`}>
        <h3 className={`font-semibold mb-4 flex items-center gap-2 ${isDark ? 'text-white' : 'text-slate-900'}`}>
          <Building2 size={20} />
          Our Company
        </h3>
        <div>
          <label className={`block text-sm font-medium mb-2 ${isDark ? 'text-slate-300' : 'text-slate-700'}`}>
            Legal Entity Name
          </label>
          <input
            type="text"
            value={formData.party_our_entity_name}
            onChange={(e) => handleChange('party_our_entity_name', e.target.value)}
            className={`w-full px-4 py-3 rounded-lg border ${
              isDark
                ? 'bg-slate-900 border-slate-700 text-white'
                : 'bg-white border-slate-300 text-slate-900'
            } focus:ring-2 focus:ring-tesa-blue focus:border-transparent`}
            placeholder="TESA GmbH"
          />
        </div>
      </div>

      <div className={`p-6 rounded-xl border ${isDark ? 'bg-slate-800/50 border-slate-700' : 'bg-white border-slate-200'}`}>
        <div className="flex items-center justify-between mb-4">
          <h3 className={`font-semibold flex items-center gap-2 ${isDark ? 'text-white' : 'text-slate-900'}`}>
            <Building2 size={20} />
            Counterparty
          </h3>
          <div className="flex items-center gap-2">
            <button
              onClick={() => setUseExistingPartner(true)}
              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                useExistingPartner
                  ? 'bg-tesa-blue text-white'
                  : isDark
                  ? 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                  : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
              }`}
            >
              <Users size={14} className="inline mr-1" />
              Existing Partner
            </button>
            <button
              onClick={() => {
                setUseExistingPartner(false);
                setSelectedPartnerId(null);
                setPartnerSearchQuery('');
              }}
              className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all ${
                !useExistingPartner
                  ? 'bg-tesa-blue text-white'
                  : isDark
                  ? 'bg-slate-700 text-slate-300 hover:bg-slate-600'
                  : 'bg-slate-100 text-slate-600 hover:bg-slate-200'
              }`}
            >
              New Partner
            </button>
          </div>
        </div>

        <div className="space-y-4">
          {useExistingPartner ? (
            <div className="relative">
              <label className={`block text-sm font-medium mb-2 ${isDark ? 'text-slate-300' : 'text-slate-700'}`}>
                Search Partner in Partner 360 Database *
              </label>
              <div className="relative">
                <Search size={18} className={`absolute left-3 top-1/2 -translate-y-1/2 ${isDark ? 'text-slate-400' : 'text-slate-500'}`} />
                <input
                  type="text"
                  value={partnerSearchQuery}
                  onChange={(e) => setPartnerSearchQuery(e.target.value)}
                  onFocus={() => partnerSuggestions.length > 0 && setShowSuggestions(true)}
                  className={`w-full pl-10 pr-4 py-3 rounded-lg border ${
                    isDark
                      ? 'bg-slate-900 border-slate-700 text-white'
                      : 'bg-white border-slate-300 text-slate-900'
                  } focus:ring-2 focus:ring-tesa-blue focus:border-transparent`}
                  placeholder="Start typing partner name..."
                  required
                />
              </div>

              {showSuggestions && partnerSuggestions.length > 0 && (
                <div className={`absolute z-10 w-full mt-2 rounded-lg border shadow-lg ${
                  isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-200'
                }`}>
                  {partnerSuggestions.map((partner) => (
                    <button
                      key={partner.id}
                      onClick={() => selectPartner(partner)}
                      className={`w-full p-4 text-left transition-colors border-b last:border-b-0 ${
                        isDark
                          ? 'border-slate-700 hover:bg-slate-700'
                          : 'border-slate-100 hover:bg-slate-50'
                      }`}
                    >
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <p className={`font-semibold ${isDark ? 'text-white' : 'text-slate-900'}`}>
                            {partner.name}
                          </p>
                          {partner.legal_name && partner.legal_name !== partner.name && (
                            <p className={`text-sm ${isDark ? 'text-slate-400' : 'text-slate-600'}`}>
                              {partner.legal_name}
                            </p>
                          )}
                          <div className="flex items-center gap-2 mt-1">
                            {partner.country && (
                              <span className={`text-xs px-2 py-0.5 rounded ${isDark ? 'bg-slate-700 text-slate-300' : 'bg-slate-100 text-slate-600'}`}>
                                {partner.country}
                              </span>
                            )}
                            {partner.risk_rating && (
                              <span className={`text-xs px-2 py-0.5 rounded ${
                                partner.risk_rating === 'low'
                                  ? 'bg-green-100 text-green-700'
                                  : partner.risk_rating === 'medium'
                                  ? 'bg-yellow-100 text-yellow-700'
                                  : 'bg-red-100 text-red-700'
                              }`}>
                                Risk: {partner.risk_rating}
                              </span>
                            )}
                          </div>
                        </div>
                      </div>
                    </button>
                  ))}
                </div>
              )}

              {selectedPartnerId && (
                <p className={`text-sm mt-2 ${isDark ? 'text-green-400' : 'text-green-600'} flex items-center gap-2`}>
                  <Building2 size={14} />
                  Partner selected from database
                </p>
              )}
            </div>
          ) : (
            <div>
              <label className={`block text-sm font-medium mb-2 ${isDark ? 'text-slate-300' : 'text-slate-700'}`}>
                Company Name *
              </label>
              <input
                type="text"
                value={formData.counterparty_name}
                onChange={(e) => handleChange('counterparty_name', e.target.value)}
                className={`w-full px-4 py-3 rounded-lg border ${
                  isDark
                    ? 'bg-slate-900 border-slate-700 text-white'
                    : 'bg-white border-slate-300 text-slate-900'
                } focus:ring-2 focus:ring-tesa-blue focus:border-transparent`}
                placeholder="Acme Corporation GmbH"
                required
              />
            </div>
          )}

          <div>
            <label className={`block text-sm font-medium mb-2 ${isDark ? 'text-slate-300' : 'text-slate-700'} flex items-center gap-2`}>
              <MapPin size={16} />
              Country *
            </label>
            <select
              value={formData.counterparty_country}
              onChange={(e) => handleChange('counterparty_country', e.target.value)}
              className={`w-full px-4 py-3 rounded-lg border ${
                isDark
                  ? 'bg-slate-900 border-slate-700 text-white'
                  : 'bg-white border-slate-300 text-slate-900'
              } focus:ring-2 focus:ring-tesa-blue focus:border-transparent`}
              required
            >
              <option value="">Select country...</option>
              <option value="DE">Germany</option>
              <option value="AT">Austria</option>
              <option value="CH">Switzerland</option>
              <option value="US">United States</option>
              <option value="UK">United Kingdom</option>
              <option value="FR">France</option>
              <option value="IT">Italy</option>
              <option value="NL">Netherlands</option>
            </select>
          </div>

          <div>
            <label className={`block text-sm font-medium mb-2 ${isDark ? 'text-slate-300' : 'text-slate-700'}`}>
              Registration Number (optional)
            </label>
            <input
              type="text"
              value={formData.counterparty_registration}
              onChange={(e) => handleChange('counterparty_registration', e.target.value)}
              className={`w-full px-4 py-3 rounded-lg border ${
                isDark
                  ? 'bg-slate-900 border-slate-700 text-white'
                  : 'bg-white border-slate-300 text-slate-900'
              } focus:ring-2 focus:ring-tesa-blue focus:border-transparent`}
              placeholder="HRB 12345"
            />
          </div>
        </div>
      </div>

      {showJurisdictionWarning && (
        <div className={`p-4 rounded-lg border ${isDark ? 'bg-yellow-900/20 border-yellow-800' : 'bg-yellow-50 border-yellow-200'} flex items-start gap-3`}>
          <AlertTriangle size={20} className="text-yellow-600 flex-shrink-0 mt-0.5" />
          <div>
            <p className={`font-medium ${isDark ? 'text-yellow-300' : 'text-yellow-800'}`}>
              Jurisdiction Mismatch
            </p>
            <p className={`text-sm mt-1 ${isDark ? 'text-yellow-400' : 'text-yellow-700'}`}>
              Counterparty is based in {formData.counterparty_country} but governing law is {contextState.jurisdiction}. This may require legal review and counterparty might push back on foreign jurisdiction.
            </p>
          </div>
        </div>
      )}

      <div>
        <label className={`block text-sm font-medium mb-2 ${isDark ? 'text-slate-300' : 'text-slate-700'} flex items-center gap-2`}>
          <Calendar size={16} />
          Effective Date
        </label>
        <input
          type="date"
          value={formData.effective_date}
          onChange={(e) => handleChange('effective_date', e.target.value)}
          className={`w-full px-4 py-3 rounded-lg border ${
            isDark
              ? 'bg-slate-900 border-slate-700 text-white'
              : 'bg-white border-slate-300 text-slate-900'
          } focus:ring-2 focus:ring-tesa-blue focus:border-transparent`}
        />
      </div>

      {showPaymentFields && (
        <>
          <div>
            <label className={`block text-sm font-semibold mb-4 ${isDark ? 'text-slate-300' : 'text-slate-700'} flex items-center gap-2`}>
              <DollarSign size={18} />
              Payment Terms
            </label>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
              {PAYMENT_TERMS.map((term) => {
                const isSelected = formData.payment_terms === term.id;
                return (
                  <button
                    key={term.id}
                    onClick={() => handleChange('payment_terms', term.id)}
                    className={`p-4 rounded-lg border-2 transition-all text-left ${
                      isSelected
                        ? 'border-tesa-blue bg-tesa-blue/10'
                        : isDark
                        ? 'border-slate-700 hover:border-slate-600 bg-slate-800/50'
                        : 'border-slate-200 hover:border-slate-300 bg-white'
                    }`}
                  >
                    <h4 className={`font-semibold mb-1 ${isDark ? 'text-white' : 'text-slate-900'}`}>
                      {term.name}
                    </h4>
                    <p className={`text-sm ${isDark ? 'text-slate-400' : 'text-slate-600'}`}>
                      {term.description}
                    </p>
                  </button>
                );
              })}
            </div>
          </div>
        </>
      )}

      <div>
        <label className={`block text-sm font-semibold mb-4 ${isDark ? 'text-slate-300' : 'text-slate-700'}`}>
          Termination Notice Period
        </label>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
              {TERMINATION_NOTICE.map((notice) => {
                const isSelected = formData.termination_notice === notice.id;
                return (
                  <button
                    key={notice.id}
                    onClick={() => handleChange('termination_notice', notice.id)}
                    className={`p-4 rounded-lg border-2 transition-all text-left ${
                      isSelected
                        ? 'border-tesa-blue bg-tesa-blue/10'
                        : isDark
                        ? 'border-slate-700 hover:border-slate-600 bg-slate-800/50'
                        : 'border-slate-200 hover:border-slate-300 bg-white'
                    }`}
                  >
                    <h4 className={`font-semibold mb-1 ${isDark ? 'text-white' : 'text-slate-900'}`}>
                      {notice.name}
                    </h4>
                    <p className={`text-sm ${isDark ? 'text-slate-400' : 'text-slate-600'}`}>
                      {notice.description}
                    </p>
                  </button>
                );
              })}
            </div>
      </div>

      {showLiabilityFields && (
        <>
          <div>
            <label className={`block text-sm font-semibold mb-4 ${isDark ? 'text-slate-300' : 'text-slate-700'}`}>
              Liability Cap Model
            </label>
            <div className="space-y-3">
              {LIABILITY_CAP_MODELS.map((model) => {
                const isSelected = formData.liability_cap_model === model.id;
                return (
                  <button
                    key={model.id}
                    onClick={() => handleChange('liability_cap_model', model.id)}
                    className={`w-full p-4 rounded-lg border-2 transition-all text-left ${
                      isSelected
                        ? 'border-tesa-blue bg-tesa-blue/10'
                        : isDark
                        ? 'border-slate-700 hover:border-slate-600 bg-slate-800/50'
                        : 'border-slate-200 hover:border-slate-300 bg-white'
                    }`}
                  >
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <div className="flex items-center gap-3 mb-1">
                          <h4 className={`font-semibold ${isDark ? 'text-white' : 'text-slate-900'}`}>
                            {model.name}
                          </h4>
                          <span
                            className={`px-2 py-1 rounded text-xs font-medium ${
                              model.risk === 'Low'
                                ? 'bg-green-100 text-green-700'
                                : model.risk === 'Medium'
                                ? 'bg-yellow-100 text-yellow-700'
                                : 'bg-red-100 text-red-700'
                            }`}
                          >
                            {model.risk} Risk
                          </span>
                        </div>
                        <p className={`text-sm ${isDark ? 'text-slate-400' : 'text-slate-600'}`}>
                          {model.description}
                        </p>
                      </div>
                    </div>
                  </button>
                );
              })}
            </div>
          </div>
        </>
      )}

      {warnings.length > 0 && (
        <div className="space-y-2">
          {warnings.map((warning, index) => (
            <div
              key={index}
              className={`p-4 rounded-lg border ${
                isDark ? 'bg-yellow-900/20 border-yellow-800' : 'bg-yellow-50 border-yellow-200'
              } flex items-start gap-3`}
            >
              <AlertCircle
                size={20}
                className={`flex-shrink-0 mt-0.5 ${
                  isDark ? 'text-yellow-400' : 'text-yellow-600'
                }`}
              />
              <p className={`text-sm ${isDark ? 'text-yellow-300' : 'text-yellow-800'}`}>
                {warning}
              </p>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
